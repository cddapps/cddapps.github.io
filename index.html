<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Bsai</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta content="A fully featured admin theme which can be used to build CRM, CMS, etc." name="description" />
        <meta content="Coderthemes" name="author" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <!-- App favicon -->
        <link rel="shortcut icon" href="assets/images/favicon.ico">
        <!-- Spinkit css -->
        <link href="assets/css/spinkit.css" rel="stylesheet" />
        <!-- App css -->
        <link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/icons.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/metismenu.min.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/style.css" rel="stylesheet" type="text/css" />
        
        <script src="assets/js/modernizr.min.js"></script>

    </head>


    <body onload="start()">

        <!-- Begin page -->
        <div id="wrapper">

            <!-- ========== Left Sidebar Start ========== -->
            <div class="left side-menu">

                <div class="slimscroll-menu" id="remove-scroll">

                    <!-- LOGO -->
                    <div class="topbar-left">
                        <a href="index.html" class="logo">
                            <span>
                                <img src="assets/images/logo.bmp" alt="" height="22">
                            </span>
                            <i>
                                <img src="assets/images/logo_sm.png" alt="" height="28">
                            </i>
                        </a>
                    </div>

                    <!-- User box -->
                    <div class="user-box">
                        <!--
                        <div class="user-img">
                            <img src="assets/images/users/avatar-1.jpg" alt="user-img" title="Mat Helme" class="rounded-circle img-fluid">
                        </div>
                        
                        <h5><a href="#">Maxine Kennedy</a> </h5>
                        <p class="text-muted">Admin Head</p>
                        -->
                    </div>

                    <!--- Sidemenu -->
                    <div id="sidebar-menu">

                        <ul class="metismenu" id="side-menu">

                            <!--<li class="menu-title">Navigation</li>-->

                            <li>
                                <a href="#" onclick="showTrade()" id="tradeButton"><i class="fi-layers"></i> <span> 交易大赛 </span></a>
                            </li>
                            <li>
                                <a href="#" onclick="showRank()"><i class="fi-align-left"></i> <span> 比赛排行 </span></a>
                            </li>
                            <li>
                                <a href="#" onclick="showWallet()"><i class="fi-head"></i> <span> 我的钱包 </span> </a>
                            </li>
                            <li>
                                <a href="#" onclick="showHome()"><i class="fi-paper"></i> <span> 使用说明 </span></a>
                            </li>
                            <li>
                                <a href="index_EN.html"><i class="fi-flag"></i> <span> English </span></a>
                            </li>
                           
                        </ul>

                    </div>
                    <!-- Sidebar -->

                    <div class="clearfix"></div>

                </div>
                <!-- Sidebar -left -->

            </div>
            <!-- Left Sidebar End -->


            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->

            <div class="content-page">

                <!-- Top Bar Start -->
                <div class="topbar">

                    <nav class="navbar-custom">

                        <ul class="list-inline menu-left mb-0">
                            <li class="float-left">
                                <button class="button-menu-mobile open-left disable-btn">
                                    <i class="dripicons-menu"></i>
                                </button>
                            </li>
                            <li>
                                <div class="page-title-box">
                                    <h4 class="page-title" id="userAddress"></h4>
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item active">本期比赛结束时间: 2018-07-10 24:00 | <span id="register"> 欢迎来到模拟交易大赛</span><span id="userBalance"></span></li>
                                    </ol>
                                </div>
                            </li>

                        </ul>

                    </nav>

                </div>
                <!-- Top Bar End -->


                <!-- Start Page content -->
                <div class="content">
                    <div class="container-fluid">
                        <div class="row">

                            <div class="col-lg-8" id="loading">
                                <div class="card-box">
                                    <!-- <h4 class="m-t-0 header-title">Rotate plane</h4> -->
                                    <div class="sk-rotating-plane"></div>
                                    <p class="text-muted text-center">
                                        正在从星云链加载您的信息，请稍等。。。
                                    </p>
                                    <p class="text-muted text-center">
                                        如果您还没有安装星云浏览器插件，请点击安装<a href="https://github.com/nebulasio/WebExtensionWallet">浏览器插件</a>
                                    </p>
                                </div>
                            </div>

                            <!-- homePage -->
                            <div class="col-lg-8" id="home" style="display:none">
                                <div class="card-box">
                                    <h3 class="m-b-20 text-center">加密货币模拟交易大赛</h3>
                                    <p >
                                        这是全球第一款去中心化的加密货币模拟交易大赛，本系统完全基于<a href="https://nebulas.io/cn/">星云链</a>智能合约标准化开发。 只需要简单的报名加入，便可以快速加入到我们的比赛中，在这里，你可以使用真实的市场价格来模拟交易任何主流加密货币。
                                    </p>
                                    <p >
                                        我们希望这款dapp可以帮助人们在没有任何风险的情况下了解如何使用星云dapp，同时还可以免费参与紧张刺激的交易大赛。我们还会为每期获得名次的用户提供免费的NAS作为奖励。
                                    </p>
                                    <p>
                                        特别提示：操作需要使用<a href="https://github.com/nebulasio/WebExtensionWallet">星云浏览器插件</a>，请在报名前先进行安装。
                                    </p>

                                    <p class="m-b-30"></p>
                                    
                                    <div class="row m-b-20">
                                        <div class="col-sm-4"> </div>
                                        <div class="col-sm-4 text-center">   
                                            <a href="#" onclick="document.getElementById('matchRule').style.display = '';">点击查看交易大赛详细说明</a>  
                                        </div>
                                        <div class="col-sm-4"> </div>
                                    </div>

                                    <p class="m-b-30"></p>

                                    <div class="row m-b-20">
                                        <div class="col-sm-4"> </div>
                                        <div class="col-sm-4">   
                                            <button type="submit" class="btn btn-block btn-success waves-effect waves-light" onclick="login()" id="want1">
                                                我要报名
                                            </button>   
                                        </div>
                                        <div class="col-sm-4"> </div>
                                    </div>
                                
                                </div>
                                <div class="card-box" id="matchRule" style="display: none">
                                        <h3 class="m-b-20 text-center">交易大赛规则与奖金</h3>
                                    <p >
                                        BSAI模拟交易大赛公平公正，所有参赛用户的初始资金为$10000，点击“我要报名”，即可实时参与当期交易大赛。您可根据您的交易策略，选择你喜欢的加密货币，进行模拟的买卖从而获取利润并且取得名次。
                                    </p>
                                    <h4 class="m-b-20">比赛周期</h4>
                                    <p >
                                        比赛周期为<strong> 10 </strong>天。 <br>
                                        每期不会间断，你可以在任何时间报名参与比赛，当然，越早越有优势。
                                    </p>
                                    <h4 class="m-b-20">每期比赛奖励</h4>
                                    <p >
                                        每期比赛奖金由BSAI和赞助商提供，每期比赛都会有不同的奖池。您可以<a href="#" onclick="showRank()">点击这里</a>查看实时的比赛奖池。（每期奖池实时累积）<br>
                                        您可以根据您的名次获得当期奖池的百分比    
                                    </p>
                                    <p>
                                        第1名 — 25% * Reward Pool<br>
                                        第2名 — 12% * Reward Pool<br>
                                        第3名 —  8% * Reward Pool<br>
                                        第4名 —  5% * Reward Pool<br>
                                        第5名 —  4% * Reward Pool<br>
                                        第6名 —  2% * Reward Pool<br>
                                        第7名 —  1% * Reward Pool<br>
                                        第8名 —  1% * Reward Pool<br>
                                        第9名 —  1% * Reward Pool<br>
                                        第10名 — 1% * Reward Pool<br>
                                        第11名—50名  — 0.5% * Reward Pool<br>
                                        第51名—150名 — 0.1% * Reward Pool<br>
                                        第151名-350名 — 0.05% * Reward Pool<br>
                                    </p>
                                    <p>
                                        一旦你获得排名，我们将会将奖池中的NAS数量按照比例支付到你报名参赛中的NAS地址中。支付过程由智能合约完全保证。
                                    </p>
                                    <h4 class="m-b-20 text-danger">注意事项 ( 必须阅读)</h4>
                                    <p>
                                        1.我们的排行榜最终只会以 美金余额 来统计。这意味着，你必须在每期比赛结束前，卖出你所有的加密货币。 一旦你获得排名，系统将会在几个小时内，将相应的NAS奖励支付到你的报名地址中。
                                    </p>
                                    <p>
                                        举个例子: <br>
                                        此时你账户有1BTC和$500。如果在比赛倒计时归0前，你还没有将你的比特币换成美金，一旦本期比赛结束，我们只能用你的$500来统计你的排名。
                                    </p>
                                    <p>
                                        2.为了防止恶意刷单或者由于众多原因发生的不公平的交易方式，当您在卖出订单时，我们会收取交易总额1.5%的费率。
                                    </p>
                                    <p>
                                        3.此版本仍为测试版，我们会根据具体的运营情况，随时改变相关信息，请保持对我们的关注。
                                    </p>

                                    <h4 class="m-b-20">联系我们</h4>
                                    <p>
                                        如果你有其它问题，欢迎发送email至 admin@bsai.io | cddapps@126.com
                                    </p>

                                    <p class="m-b-30"></p>

                                    <div class="row m-b-20">
                                        <div class="col-sm-4"> </div>
                                        <div class="col-sm-4">   
                                            <button type="submit" class="btn btn-block btn-success waves-effect waves-light" onclick="login()" id="want2">
                                                我要报名
                                            </button>   
                                        </div>
                                        <div class="col-sm-4"> </div>
                                    </div>
                                    
                                </div>
                                <div id="homeText" style="display: none">
                                    <div class="card m-b-30 text-white bg-primary text-xs-center">
                                        <div class="card-body">
                                            <blockquote class="card-bodyquote" id="tradeAlert">
                                                <h3 class="m-b-20 text-center">请到浏览器插件中完成操作！</h4>
                                                <p>
                                                </p>
                                            </blockquote>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- tradePage -->
                            <div class="col-lg-8" id="trade"  style="display: none">
                                <div class="card-box">
                                    <div id="coinShow">
                                        <h4 class="m-t-0 header-title">持币数量:0 | 可用资金:$10000</h4>
                                        <div class="row text-center">
                                            <div class="col-sm-3 col-lg-3 col-xl-3"></div>
                                            <div class="col-sm-6 col-lg-6 col-xl-6">
                                                <div class="card-box tilebox-one">
                                                    <h6 class="text-muted text-uppercase mt-0">BTC</h6>
                                                    <h2 class="m-b-20">$<span data-plugin="counterup" id="currentPrice">--</span></h2>
                                                    <span class="text-muted">24小时涨跌幅：</span>
                                                    <span id="currentRate"><span class="badge">--</span></span> 
                                                </div>
                                            </div>
                                            <div class="col-sm-3 col-lg-3 col-xl-3"></div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="form-row col-sm-12">
                                            <div class="form-group col-md-6">
                                                    <label for="inputEmail4" class="col-form-label">数量 <span id="coinType">BTC</span> </label>
                                                    <input type="text" class="form-control" id="coinAmount" placeholder="">
                                            </div>
                                            <div class="form-group col-md-6">
                                                    <label for="inputEmail4" class="col-form-label">金额 <span>USD</span> </label>
                                                    <input type="text" class="form-control" id="coinValue" placeholder="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="form-row col-sm-12">
                                            <div class="form-group col-md-6">
                                                    <a href="#" class="btn btn-block btn-custom waves-effect waves-light" onclick="buy()">买入</a>
                                            </div>
                                            <div class="form-group col-md-6">
                                                    <a href="#" class="btn btn-block btn-danger waves-effect waves-light" onclick="sell()">卖出</a>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row" id="warning">
                                        <div class="col-md-12">
                                            <div class="card m-b-30 text-white bg-primary text-xs-center">
                                                <div class="card-body">
                                                    <blockquote class="card-bodyquote">
                                                        <p>特别须知：</p>
                                                        <p>1.每期排行仅统计当前美金余额，比赛截止前请自行卖出持有虚拟币。</p>
                                                        <p>2.为防止恶意刷单/超短线下单，每笔卖出交易将会扣除1.5%的手续费。</p>
                                                        <!-- <p>3.频繁短线，刷单的盈利会被清除。此类交易不符合设计初衷以及真实市场情况，请勿滥用。</p> -->
                                                        <p>3.如果你有更多的问题，可通过邮箱与我们联系: admin@bsai.io | cddapps@126.com</p>
                                            
                                                    </blockquote>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="tradeText" style="display: none">
                                            <div class="card m-b-30 text-white bg-primary text-xs-center">
                                                <div class="card-body">
                                                    <blockquote class="card-bodyquote" id="tradeAlert2">
                                                        <h3 class="m-b-20 text-center">请到浏览器插件中完成操作！</h4>
                                                        <p>
                                                        </p>
                                                    </blockquote>
                                                </div>
                                            </div>
                                        </div>

                                </div>
                            </div>

                            <!-- walletPage -->
                            <div class="col-lg-8"  id="wallet" style="display: none">
                                <div class="card-box">
                                    <h4 class="header-title mb-3">我的钱包</h4>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-centered m-0">
                                            <thead>
                                            <tr>
                                                <th>币种</th>
                                                <th>数量</th>
                                                <th>交易</th>
                                            </tr>
                                            </thead>
                                            <tbody id="myWallet">
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- rankPage -->
                            <div class="col-lg-8"  id="rank" style="display: none">
                                <div class="card-box">
                                    <h4 class="header-title m-t-0 m-b-30 text-center"><span id="round">本</span>期比赛排行榜 | 奖金池金额 20 NAS</h4>
                                    <ul class="nav nav-pills navtab-bg nav-justified pull-in ">
                                        <li class="nav-item">
                                            <a href="#home1" data-toggle="tab" aria-expanded="false" class="nav-link active" onclick="loadRank(0)">
                                                本期排行(实时变化)
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a href="#profile1" data-toggle="tab" aria-expanded="true" class="nav-link" onclick="" id="lastRank">
                                                上期排行
                                            </a>
                                        </li>
                                    </ul>                                  
                                    <div class="table-responsive" id="rankTable" style="display: none">
                                        <table class="table table-hover table-centered m-0">
                                            <thead>
                                                <tr>
                                                    <th>账户地址</th>
                                                    <th>排名</th>
                                                    <th>资金</th>
                                                    <th>盈亏</th>
                                                    <th>奖金</th>
                                                </tr>
                                            </thead>
                                            <tbody id="rankList"></tbody>
                                        </table>
                                    </div>
                                    <div id="rankWave">
                                        <div class="sk-wave">
                                            <div class="sk-rect sk-rect1"></div>
                                            <div class="sk-rect sk-rect2"></div>
                                            <div class="sk-rect sk-rect3"></div>
                                            <div class="sk-rect sk-rect4"></div>
                                            <div class="sk-rect sk-rect5"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- coinPage -->
                            <div class="col-lg-4">
                                <div class="card-box">
                                    <h4 class="header-title mb-3 text-center">交易列表</h4>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-centered m-0">
                                            <thead>
                                            <tr>
                                                <th>币种</th>
                                                <th>价格</th>
                                                <th>24H涨跌</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr id="BTC" onclick="">
                                                <td>BTC</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="ETH" onclick="">
                                                <td> ETH</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="XRP" onclick="">
                                                <td> XRP</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="BCH" onclick="">
                                                <td>BCH</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="EOS" onclick="">
                                                <td> EOS</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="LTC" onclick="">
                                                <td>LTC</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="XLM" onclick="">
                                                <td> XLM</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="ADA" onclick="">
                                                <td> ADA</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="IOT" onclick="">
                                                <td>IOT</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="TRX" onclick="">
                                                <td> TRX</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>

                            
                        </div>
                        <!-- end row -->


                    </div> <!-- container -->

                </div> <!-- content -->


                <footer class="footer text-right">
                    2018 © Bsai - powered by nebulas.
                </footer>

            </div>


            <!-- ============================================================== -->
            <!-- End Right content here -->
            <!-- ============================================================== -->


        </div>
        <!-- END wrapper -->

        <!-- jQuery  -->
        <script src="assets/js/jquery.min.js"></script>
        <script src="assets/js/popper.min.js"></script>
        <script src="assets/js/bootstrap.min.js"></script>
        <script src="assets/js/metisMenu.min.js"></script>
        <script src="assets/js/waves.js"></script>
        <script src="assets/js/jquery.slimscroll.js"></script>>

        <!-- KNOB JS -->
        <!--[if IE]>
        <script type="text/javascript" src="../plugins/jquery-knob/excanvas.js"></script>
        <![endif]-->
        <!-- App js -->
        <script src="assets/js/jquery.app.js"></script>
        <!--<script src="https://cdn.jsdelivr.net/npm/nebulas@0.5.2/dist/nebulas.js"></script>-->
        <script src="nebPay.js"></script>
        <script src="lib/nebulas.js"></script>

        <script>
            'use strict';
            var Neb = require("nebulas").Neb;
            var HttpRequest = require("nebulas").HttpRequest
            var NebPay = require("nebpay");
            var nebPay = new NebPay(); 
            var Account = require("nebulas").Account;
            var contractAddress = "n1uTqUTv1nb78trkdCmRve4EeG5RFuDZags";
            var intervalQuery;

            var neb = new Neb();
            var chainId = 1;
            var netWork = "https://mainnet.nebulas.io"
            //var chainId = 1001;
            //var netWork = "https://testnet.nebulas.io"
            neb.setRequest(new HttpRequest(netWork));
            var callbackUrl = NebPay.config.mainnetUrl;

            var serialNumber;
            var mQuery;
            var intervalQuery;
            var accountQuery;
            var priceQuery;
            var awardPool = 20;
            
            var userAddress = "n1TSPLnEhUcqx3eeBYbpAzoi6sAUSQ4ME1q";
            var userLoaded = 0;
            var userBalance = "";
            var userCurrentCount="";
            var userWallet="";
            var userCoinList = new Array();
            var register = 0;
            var currentPrice;
            var currentCoin;
            var onTrade=0;
            var matchRound=0;
            var lastRound=0;
            var firstLoad=0;

            var btcValue=0;
            var ethValue=0;
            var xrpValue=0;
            var bchValue=0;
            var eosValue=0;
            var ltcValue=0;
            var xlmValue=0;
            var adaValue=0;
            var iotValue=0;
            var trxValue=0;
            
            function loginQuery(txhash) {
                document.getElementById("tradeAlert").innerHTML = `
                        <h3 class="m-b-20 text-center">正在查询报名结果，请稍等。。。</h4>
                        <p></p>`
                receiptTransaction(txhash).then(function(resp){
                    var respObject = resp;
                    console.log(respObject)
                    if (respObject.status == 1){
                        clearInterval(intervalQuery);
                        document.getElementById("tradeAlert").innerHTML = `
                        <h3 class="m-b-20 text-center">报名成功，3秒后将刷新页面重新开始！</h4>
                        <p></p>`
                        setTimeout(window.location.reload(), 10000)
                    } else if (respObject.status == 0) {
                        clearInterval(intervalQuery);
                        var result = respObject.execute_result;
                        if (result == 'Error: You have registered'){
                            document.getElementById("tradeAlert").innerHTML = `
                            <h3 class="m-b-20 text-center">报名失败了！</h4>
                            <p class="text-center">本轮比赛您已经报过名了，请不要重复报名！</p>`
                        } else {
                            document.getElementById("tradeAlert").innerHTML = `
                            <h3 class="m-b-20 text-center">报名失败了！</h4>
                            <p class="text-center">您可以根据以下哈希，再次确认您的交易状态:</p>
                            <p>${txhash}</p>`
                        }  
                    }
                }).catch(function(err){
                    clearInterval(intervalQuery);
                    document.getElementById("tradeAlert").innerHTML = `
                        <h3 class="m-b-20 text-center">报名失败了！</h4>
                        <p>您可以根据以下哈希，再次确认您的交易状态:</p>
                        <p>${txhash}</p>`
                })
            }

            function tradeQuery(txhash) {
                document.getElementById("tradeAlert2").innerHTML = `
                        <h3 class="m-b-20 text-center">正在查询交易结果，请稍等。。。</h4>
                        <p></p>`
                receiptTransaction(txhash).then(function(resp){
                    var respObject = resp;
                    console.log(respObject)
                    if (respObject.status == 1){
                        clearInterval(intervalQuery);
                        document.getElementById("tradeAlert2").innerHTML = `
                        <h3 class="m-b-20 text-center">交易成功!</h3>
                        <p class="text-center">您可以根据以下哈希，再次确认您的交易状态:</p>
                        <p class="text-center">${txhash}</p>
                        <a class="btn btn-block btn-custom waves-effect waves-light" 
                        onclick="document.getElementById('tradeText').style.display = 'none';document.getElementById('warning').style.display = '';">
                            知道了
                        </a>`
                        userLoaded = 0;
                        loadAccount();
                    } else if (respObject.status == 0) {
                        console.log("交易失败")
                        clearInterval(intervalQuery);
                        document.getElementById("tradeAlert2").innerHTML = `
                        <h3 class="m-b-20 text-center">交易失败!</h3>
                        <p class="text-center">您可以根据以下哈希，再次确认您的交易状态:</p>
                        <p class="text-center">${txhash}</p>
                        <a class="btn btn-block btn-custom waves-effect waves-light" 
                        onclick="document.getElementById('tradeText').style.display = 'none';document.getElementById('warning').style.display = '';">
                            知道了
                        </a>`
                    }
                }).catch(function(err){
                    console.log("交易失败")
                    clearInterval(intervalQuery);
                    document.getElementById("tradeAlert2").innerHTML = `
                    <h3 class="m-b-20 text-center">交易失败!</h3>
                    <p class="text-center">您可以根据以下哈希，再次确认您的交易状态:</p>
                    <p class="text-center">${txhash}</p>
                    <a class="btn btn-block btn-custom waves-effect waves-light" 
                    onclick="document.getElementById('tradeText').style.display = 'none';document.getElementById('warning').style.display = '';">
                        知道了
                    </a>`
                })
            }

            function mobileQuery(serialNumber) {
                var mq = intervalQuery = setInterval(function() {
                    nebPay.queryPayInfo(serialNumber,{callback: callbackUrl}).then(function (resp) {
                        resp = JSON.parse(resp)
                        if(resp instanceof Object){
                            if(resp.code === 0){  
                                alert(resp.code)
                                var data = resp.data;
                                if (data instanceof Object){
                                    clearInterval(mq)
                                    var userAddress = data.from;
                                    alert(userAddress);
                                    localStorage.setItem('userAddress', userAddress);
                                    var txhash = data.hash
                                    intervalQuery = setInterval(function() {
                                        tradeQuery(txhash);
                                    }, 3000);
                                }
                            } 
                        }
                    }).catch(function (err) {
                        alert("error:" + err)
                        console.log(err);
                    })}, 3000);
            }
            
            function login() {
                document.getElementById('matchRule').style.display = 'none'
                document.getElementById('homeText').style.display = ''
                document.getElementById("tradeAlert").innerHTML = `
                <h3 class="m-b-20 text-center">请到浏览器插件中完成操作！</h4>
                <p></p>`
                var to = contractAddress;
                var value = 0;
                var callFunction = "register";
                var callArgs =  JSON.stringify([]);
                var options = {
                    qrcode: {
                        showQRCode: false,      //是否显示二维码信息
                        container: undefined,    //指定显示二维码的canvas容器，不指定则生成一个默认canvas
                        completeTip: undefined, // 完成支付提示
                        cancelTip: undefined // 取消支付提示
                    },
                    extension: {
                        openExtension: true //是否支持插件调用
                    },
                    mobile: {
                        showInstallTip: true, //是否支持手机钱包安装提示
                        installTip: undefined // 手机钱包安装提示
                    },
                    listener: function (serialNumber,result) {
                        console.log(result)
                        if(result == "Error: Transaction rejected by user"){
                            alert("您已取消交易！")
                        } else {
                            var txhash = result.txhash;
                            console.log(txhash)
                            intervalQuery = setInterval(function() {
                                loginQuery(txhash);
                            }, 3000);
                        }
                    }
                }
                //发送交易(发起智能合约调用)
                serialNumber = nebPay.call(to, value, callFunction, callArgs, options);
                mobileQuery(serialNumber);
                
            }

            function buy(){
                var count = document.getElementById('coinAmount').value.trim();
                var usd = document.getElementById('coinValue').value.trim();
                if (count == "") {
                    alert("请输入买入数量");
                } else if(isNaN(parseFloat(count))) {
                    alert("请输入正确数值");
                } else if(parseFloat(usd) > userBalance) {
                    alert("您的余额不足，请调低买入数量");
                }else {
                    document.getElementById('warning').style.display = 'none'
                    document.getElementById('tradeText').style.display = ''
                    document.getElementById("tradeAlert2").innerHTML = `
                    <h3 class="m-b-20 text-center">请到浏览器插件中完成操作！</h4>
                    <p></p>`
                    
                    var to = contractAddress;
                    var value = 0;
                    var callFunction = "buyCoin";
                    var callArgs =  JSON.stringify([currentCoin, count]);
                    var options = {
                        qrcode: {
                            showQRCode: false,      //是否显示二维码信息
                            container: undefined,    //指定显示二维码的canvas容器，不指定则生成一个默认canvas
                            completeTip: undefined, // 完成支付提示
                            cancelTip: undefined // 取消支付提示
                        },
                        extension: {
                            openExtension: true //是否支持插件调用
                        },
                        mobile: {
                            showInstallTip: true, //是否支持手机钱包安装提示
                            installTip: undefined // 手机钱包安装提示
                        },
                        listener: function (serialNumber,result) {
                            console.log(result)
                            if(result == "Error: Transaction rejected by user"){
                                alert("您已取消交易！")
                            } else {
                                var txhash = result.txhash;
                                console.log(txhash)
                                intervalQuery = setInterval(function() {
                                    tradeQuery(txhash);
                                }, 3000);
                            }
                        }
                    }
                    //发送交易(发起智能合约调用)
                    serialNumber = nebPay.call(to, value, callFunction, callArgs, options)
                    mobileQuery(serialNumber);
                }
            }

            function sell(){
                var count = document.getElementById('coinAmount').value.trim();
                if (count == "") {
                    alert("请输入卖出数量");
                } else if(isNaN(parseFloat(count))) {
                    alert("请输入正确数值");
                } else if(parseFloat(count) > userCurrentCount) {
                    alert("您的币数不足，请调低卖出数量");
                }else {
                    document.getElementById('warning').style.display = 'none'
                    document.getElementById('tradeText').style.display = ''
                    document.getElementById("tradeAlert2").innerHTML = `
                    <h3 class="m-b-20 text-center">请到浏览器插件中完成操作！</h4>
                    <p></p>`
                    var to = contractAddress;
                    var value = 0;
                    var callFunction = "sellCoin";
                    var callArgs =  JSON.stringify([currentCoin, count]);
                    var options = {
                        qrcode: {
                            showQRCode: false,      //是否显示二维码信息
                            container: undefined,    //指定显示二维码的canvas容器，不指定则生成一个默认canvas
                            completeTip: undefined, // 完成支付提示
                            cancelTip: undefined // 取消支付提示
                        },
                        extension: {
                            openExtension: true //是否支持插件调用
                        },
                        mobile: {
                            showInstallTip: true, //是否支持手机钱包安装提示
                            installTip: undefined // 手机钱包安装提示
                        },
                        listener: function (serialNumber,result) {
                            console.log(result)
                            if(result == "Error: Transaction rejected by user"){
                                alert("您已取消交易！")
                            } else {
                                var txhash = result.txhash;
                                console.log(txhash)
                                intervalQuery = setInterval(function() {
                                    tradeQuery(txhash);
                                }, 3000);
                            }
                        }
                    }
                    //发送交易(发起智能合约调用)
                    serialNumber = nebPay.call(to, value, callFunction, callArgs, options)
                    mobileQuery(serialNumber);
                }
            } 
            
            function start(){
                loadInfo();
                if (!userAddress){
                    userAddress = localStorage.getItem('userAddress');
                }
                console.log(userAddress)
                if (IsPC() || userAddress) {
                    accountQuery = setInterval(function() {
                        loadAccount().then(function(data){
                            console.log
                            if (data != ""){
                                getPrice();
                            } 
                        });
                    }, 1000)
                } else {
                    showHome()
                }
            }

            function loadAccount() {
                return new Promise( function(resolve, reject){
                    if (userLoaded == 0){
                        getUserAddress();
                        console.log(userAddress)
                        localStorage.setItem('userAddress', userAddress);
                        document.getElementById("userAddress").innerText = userAddress;
                        console.log('loading accountInfo')
                        neb.api.call({
                            chainID: chainId,
                            from: contractAddress,
                            to: contractAddress,
                            value: 0,
                            nonce: 0,
                            gasPrice: 1000000,
                            gasLimit: 2000000,
                            contract: {
                                function: "searchUser",
                                args: JSON.stringify([userAddress]),
                            }
                        }).then(function (resp) {
                            var result = JSON.parse(resp.result)
                            if(result == null){
                                console.log(result)
                                userBalance = -1;
                                document.getElementById("register").innerText = `您还没有参加本轮比赛`
                                showHome();
                            } else {
                                userLoaded = 1;
                                register = 1;
                                userBalance = result.balance;
                                document.getElementById("register").innerText = `您的可用资金：$`
                                document.getElementById("userBalance").innerText = `${userBalance}`
                                userWallet = result.coinList;
                                loadWallet();
                            }
                            console.log('loaded accountInfo')
                            resolve(userBalance);
                        }).catch(function(err) {
                            console.log('account load error');
                            resolve(userBalance);
                        })    
                    } else {
                        resolve(userBalance);
                    }
                })
            }
            
            function loadRank(round) {
                document.getElementById("rankList").innerHTML = ''
                document.getElementById('rankWave').style.display = '';
                document.getElementById('rankTable').style.display = 'none';
                if (isNaN(parseInt(round))){
                    alert("请输入正确的参数！")
                } else {
                    console.log('loading rank')
                    if (!round){
                        if (matchRound){
                            document.getElementById('round').innerHTML = `第${matchRound}`
                        } else {
                            document.getElementById('round').innerHTML = "本"
                        }
                    } else {
                        document.getElementById('round').innerHTML = `第${round}`
                    }
                    neb.api.call({
                        chainID: chainId,
                        from: contractAddress,
                        to: contractAddress,
                        value: 0,
                        nonce: 0,
                        gasPrice: 1000000,
                        gasLimit: 2000000,
                        contract: {
                            function: "searchRank",
                            args: JSON.stringify([parseInt(round)]),
                        }
                    }).then(function (resp) {
                        var userList = JSON.parse(resp.result)
                        if(userList.length == 0){
                            document.getElementById("rankWave").innerHTML = `
                            <h3>本轮比赛还没有人报名，快来成为第一个吧！</h3>`
                        } else {
                            if(matchRound == 0){
                                matchRound = parseInt(userList[0].round);
                                lastRound = matchRound - 1;
                                document.getElementById('lastRank').onclick = function(){loadRank(lastRound)}
                            }
                            var finalList = new Array()
                            for (var u of userList){
                                if(u.balance != 10000){
                                    finalList.push(u)
                                }
                            }
                            finalList.sort(function(li1, li2){
                                var n1=parseInt(li1.balance);  
                                var n2=parseInt(li2.balance);  
                                return n2-n1; 
                            });
                            console.log(finalList)
                            document.getElementById('rankWave').style.display = 'none';
                            document.getElementById('rankTable').style.display = '';
                            for (var j=0;j<finalList.length;j++){
                                var user = finalList[j];
                                var i = j+1;
                                var rate = ((user.balance-10000)/100).toFixed(2);
                                var award = 0;
                                if(i == 1){
                                    award = parseFloat(awardPool*0.25).toFixed(2);
                                } else if(i == 2){
                                    award = parseFloat(awardPool*0.12).toFixed(2);
                                } else if(i == 3){
                                    award = parseFloat(awardPool*0.08).toFixed(2);
                                } else if(i == 4){
                                    award = parseFloat(awardPool*0.05).toFixed(2);
                                } else if(i == 5){
                                    award = parseFloat(awardPool*0.04).toFixed(2);
                                } else if(i == 6){
                                    award = parseFloat(awardPool*0.02).toFixed(2);
                                } else if(i>=7 && i<= 10){
                                    award = parseFloat(awardPool*0.01).toFixed(2);
                                } else if(i>=11 && i<= 50){
                                    award = parseFloat(awardPool*0.005).toFixed(2);
                                } else if(i>=51 && i<= 150){
                                    award = parseFloat(awardPool*0.001).toFixed(2);
                                } else if(i>=151 && i<= 350){
                                    award = parseFloat(awardPool*0.0005).toFixed(2);
                                } 
                                var html = `
                                <tr>
                                    <td>${user.address}</td>
                                    <td>${i}</td>
                                    <td>${parseFloat(user.balance).toFixed(2)}</td>
                                    <td>${rate}%</td>
                                    <td>${award}NAS</td>
                                </tr>`
                                document.getElementById("rankList").insertAdjacentHTML('beforeend', html);
                            }
                            
                        }
                        console.log('loaded rank')
                    }).catch(function(err) {
                        console.log(err);
                        loadRank(parseInt(round))
                    }) 
                }
            }
            
            function loadInfo(){
                console.log('loading info')
                neb.api.call({
                    chainID: chainId,
                    from: contractAddress,
                    to: contractAddress,
                    value: 0,
                    nonce: 0,
                    gasPrice: 1000000,
                    gasLimit: 2000000,
                    contract: {
                        function: "searchInfo",
                        args: JSON.stringify([]),
                    }
                }).then(function (resp) {
                    var info = JSON.parse(resp.result)
                    matchRound = parseInt(info.round);
                    lastRound = matchRound - 1;
                    document.getElementById('lastRank').onclick = function(){loadRank(lastRound)}
                    console.log(`第${matchRound}轮比赛`)
                    document.getElementById('round').innerText = matchRound;
                    console.log('loaded info')
                }).catch(function(err) {
                    console.log(err);
                    loadInfo()
                }) 

            }
            
            function loadWallet() {
                console.log('loading wallet')
                userWallet.sort(function(li1, li2){
                    var n1=parseInt(li1.count);  
                    var n2=parseInt(li2.count);  
                    return n2-n1; 
                });

                userCoinList = new Array();
                for (var c of userWallet) {
                    userCoinList.push(c.name)
                }
                
                document.getElementById("myWallet").innerHTML = ''
                for (var i=0;i<userWallet.length;i++){
                    var coin = userWallet[i];
                    var name = coin.name;
                    var count = coin.count;
                    var html = `
                    <tr>
                        <td>${name}</td>
                        <td>${count}</td>
                        <td><a href="#" class="btn btn-sm btn-custom" id="${name.toLowerCase()}" onclick="">交易</a></td>
                    </tr>`
                    document.getElementById("myWallet").insertAdjacentHTML('beforeend', html);
                }
                console.log('loaded wallet')
            }
            
            function getPrice() {
                console.log('loading price')
                neb.api.call({
                    chainID: chainId,
                    from: contractAddress,
                    to: contractAddress,
                    value: 0,
                    nonce: 0,
                    gasPrice: 1000000,
                    gasLimit: 2000000,
                    contract: {
                        function: "searchCoin",
                        args: JSON.stringify([]),
                    }
                }).then(function (resp) {
                    //console.log('loaded price')
                    var result = JSON.parse(resp.result)
                    for (var coin of result) {
                        var name = coin.name;
                        switch(name)
                        {
                        case "BTC":
                            showList(coin, btcValue)
                            btcValue = coin.price;
                            break;
                        case "ETH":
                            showList(coin, ethValue)
                            ethValue = coin.price;
                            break;
                        case "XRP":
                            showList(coin, xrpValue)
                            xrpValue = coin.price;
                            break;
                        case "BCH":
                            showList(coin, bchValue)
                            bchValue = coin.price;
                            break;
                        case "EOS":
                            showList(coin, eosValue)
                            eosValue = coin.price;
                            break;
                        case "LTC":
                            showList(coin, ltcValue)
                            ltcValue = coin.price;
                            break;
                        case "XLM":
                            showList(coin, xlmValue)
                            xlmValue = coin.price;
                            break;
                        case "ADA":
                            showList(coin, adaValue)
                            adaValue = coin.price;
                            break;
                        case "IOT":
                            showList(coin, iotValue)
                            iotValue = coin.price;
                            break;
                        case "TRX":
                            showList(coin, trxValue)
                            trxValue = coin.price;
                            break;
                        }
                    }
                }).catch(function(err) {
                    console.log('price load error');;
                })
            }
            
            function showCoin(coin, price, rate, rateColor) {
                //console.log(coin)
                if (register == 0){
                    alert('请先点击"我要报名"，参加本轮比赛')
                } else {
                    onTrade = 1;
                    if (coin != currentCoin){
                        document.getElementById('coinAmount').value = '';
                        document.getElementById('coinValue').value = '';
                    }
                    currentPrice = price;
                    currentCoin = coin;
                    var count = 0;
                    if (userWallet){
                        for (var dic of userWallet){
                            var coinName = dic.name;
                            if (coinName == coin){
                                count = dic.count;
                                break;
                            }
                        }
                        showTrade()
                    }
                    userCurrentCount = count;
                    document.getElementById("coinType").innerText = coin
                    document.getElementById("coinShow").innerHTML = `
                    <h4 class="m-t-0 header-title"> 可用资金:$${userBalance} | 持币数量:${count}</h4>
                    <div class="row text-center">
                        <div class="col-sm-3 col-lg-3 col-xl-3"></div>
                        <div class="col-sm-6 col-lg-6 col-xl-6">
                            <div class="card-box tilebox-one">
                                <h6 class="text-muted text-uppercase mt-0">${coin}</h6>
                                <h2 class="m-b-20">$<span data-plugin="counterup">${price}</span></h2>
                                <span class="text-muted">24小时涨跌幅：</span>
                                <span id="currentRate"><span class="badge badge-${rateColor}">${rate}%</span></span> 
                            </div>
                        </div>
                        <div class="col-sm-3 col-lg-3 col-xl-3"></div>
                    </div>`
                }
            }
            
            function showList(coin, preValue){
                var valueColor = 'default';
                var rateColor = 'default';
                var value = parseFloat(coin.price);
                var rate = parseFloat(coin.rate)
                if (value > preValue){
                    valueColor = 'custom'
                } else if (value < preValue) (
                    valueColor = 'danger'
                )
                if (rate > 0){
                    rateColor = 'custom'
                } else if (rate < 0) {
                    rateColor = 'danger'
                }
                document.getElementById(coin.name).innerHTML = `
                <td>${coin.name}</td>
                <td class="text-${valueColor}">$${value}</td>
                <td><span class="text-${rateColor}">${rate}%</span></td>`
                document.getElementById(coin.name).onclick = function(){
                    showCoin(coin.name, value, rate, rateColor)
                }
                if(userCoinList.indexOf(coin.name)>=0){
                    document.getElementById(coin.name.toLowerCase()).onclick = function(){
                        showCoin(coin.name, value, rate, rateColor)
                    }
                }
                if (coin.name == "BTC" && register == 1) {
                    document.getElementById("tradeButton").onclick = function(){
                        showCoin(coin.name, value, rate, rateColor)
                    } 
                    if(firstLoad==0){
                        firstLoad = 1;
                        document.getElementById("tradeButton").click();
                    }
                }
                if (coin.name == currentCoin && onTrade == 1) {
                    showCoin(currentCoin, value, rate, rateColor)
                }
            }

            function showHome() {
                onTrade = 0;
                document.getElementById("home").style.display = 'inline';
                document.getElementById("loading").style.display = 'none';
                document.getElementById("trade").style.display = 'none';
                document.getElementById("wallet").style.display = 'none';
                document.getElementById("rank").style.display = 'none';
                document.getElementById('homeText').style.display = 'none'
                if(userBalance > 0){
                    document.getElementById("want1").innerText = "您已报名"
                    document.getElementById("want1").disabled = true;
                    document.getElementById("want2").innerText = "您已报名"
                    document.getElementById("want2").disabled = true;
                }
                
            }
            
            function showTrade() {
                if (register == 0) {
                    alert('请先点击"我要报名"，参加本轮比赛')
                } else {
                    onTrade = 1;
                    document.getElementById("trade").style.display = 'inline';
                    document.getElementById("loading").style.display = 'none';
                    document.getElementById("home").style.display = 'none';
                    document.getElementById("wallet").style.display = 'none';
                    document.getElementById("rank").style.display = 'none';
                    document.getElementById('homeText').style.display = 'none'
                }
            }

            function showWallet() {
                if (register == 0) {
                    alert('请先点击"我要报名"，参加本轮比赛')
                } else {
                    onTrade = 0;
                    document.getElementById("wallet").style.display = 'inline';
                    document.getElementById("loading").style.display = 'none';
                    document.getElementById("home").style.display = 'none';
                    document.getElementById("trade").style.display = 'none';
                    document.getElementById("rank").style.display = 'none';
                    document.getElementById('homeText').style.display = 'none'
                }
            }

            function showRank() {
                onTrade = 0;
                document.getElementById("rank").style.display = 'inline';
                document.getElementById("loading").style.display = 'none';
                document.getElementById("home").style.display = 'none';
                document.getElementById("trade").style.display = 'none';
                document.getElementById("wallet").style.display = 'none';
                document.getElementById('homeText').style.display = 'none';
                loadRank(0)
            }

            function receiptTransaction(txhash) {
                var promise = new Promise(function(resolve, reject){
                    neb.api.getTransactionReceipt(txhash).then(function (resp) {
                        resolve(resp);
                    }).catch(function(err) {
                        console.log(err);
                    });
                });
                return promise
            }

            function IsPC() {  
                var userAgentInfo = navigator.userAgent;  
                var Agents = new Array("Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod");  
                var flag = true;  
                for (var v = 0; v < Agents.length; v++) {  
                    if (userAgentInfo.indexOf(Agents[v]) > 0) { flag = false; break; }  
                }  
                return flag;  
             } 

            function getUserAddress() {
                if(IsPC()){
                    window.postMessage(
                    {
                        target: 'contentscript',
                        // data: 'a',
                        method: 'getAccount'
                    },
                    '*'
                    )
                    window.addEventListener('message', function(e) {
                    if (e.data && e.data.data && e.data.data.account) {
                        userAddress = e.data.data.account;
                    }
                    })
                }
            }

            $(function(){  
                $('#coinAmount').bind('input propertychange', function() {  
                    var a = $('#coinAmount').val();
                    var b;
                    if(a == ""){
                        b = "";
                    } else {
                        b = a*currentPrice;
                    }
                    $('#coinValue').val(b);  
                }); 

                $('#coinValue').bind('input propertychange', function() {  
                    var a = $('#coinValue').val();
                    var b;
                    if(a == ""){
                        b = "";
                    } else {
                        b = a/currentPrice;
                    }
                    $('#coinAmount').val(b);  
                }); 
            })

        </script>


    </body>
</html>