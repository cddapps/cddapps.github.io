<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Bsai</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta content="A fully featured admin theme which can be used to build CRM, CMS, etc." name="description" />
        <meta content="Coderthemes" name="author" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <!-- App favicon -->
        <link rel="shortcut icon" href="assets/images/favicon.ico">
        <!-- Spinkit css -->
        <link href="assets/css/spinkit.css" rel="stylesheet" />
        <!-- App css -->
        <link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/icons.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/metismenu.min.css" rel="stylesheet" type="text/css" />
        <link href="assets/css/style.css" rel="stylesheet" type="text/css" />
        
        <script src="assets/js/modernizr.min.js"></script>

    </head>


    <body onload="start()">

        <!-- Begin page -->
        <div id="wrapper">

            <!-- ========== Left Sidebar Start ========== -->
            <div class="left side-menu">

                <div class="slimscroll-menu" id="remove-scroll">

                    <!-- LOGO -->
                    <div class="topbar-left">
                        <a href="index.html" class="logo">
                            <span>
                                <img src="assets/images/logo.bmp" alt="" height="22">
                            </span>
                            <i>
                                <img src="assets/images/logo_sm.png" alt="" height="28">
                            </i>
                        </a>
                    </div>

                    <!-- User box -->
                    <div class="user-box">
                        <!--
                        <div class="user-img">
                            <img src="assets/images/users/avatar-1.jpg" alt="user-img" title="Mat Helme" class="rounded-circle img-fluid">
                        </div>
                        
                        <h5><a href="#">Maxine Kennedy</a> </h5>
                        <p class="text-muted">Admin Head</p>
                        -->
                    </div>

                    <!--- Sidemenu -->
                    <div id="sidebar-menu">

                        <ul class="metismenu" id="side-menu">

                            <!--<li class="menu-title">Navigation</li>-->

                            <li>
                                <a href="#" onclick="showTrade()" id="tradeButton"><i class="fi-layers"></i> <span> Contest </span></a>
                            </li>
                            <li>
                                <a href="#" onclick="showRank()"><i class="fi-align-left"></i> <span> Leaderboard </span></a>
                            </li>
                            <li>
                                <a href="#" onclick="showWallet()"><i class="fi-head"></i> <span> My Wallet </span> </a>
                            </li>
                            <li>
                                <a href="#" onclick="showHome()"><i class="fi-paper"></i> <span> How to start </span></a>
                            </li>
                            <li>
                                <a href="index.html"><i class="fi-flag"></i> <span> 中文 </span></a>
                            </li>
                           
                        </ul>

                    </div>
                    <!-- Sidebar -->

                    <div class="clearfix"></div>

                </div>
                <!-- Sidebar -left -->

            </div>
            <!-- Left Sidebar End -->


            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->

            <div class="content-page">

                <!-- Top Bar Start -->
                <div class="topbar">

                    <nav class="navbar-custom">

                        <ul class="list-inline menu-left mb-0">
                            <li class="float-left">
                                <button class="button-menu-mobile open-left disable-btn">
                                    <i class="dripicons-menu"></i>
                                </button>
                            </li>
                            <li>
                                <div class="page-title-box">
                                    <h4 class="page-title" id="userAddress"></h4>
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item active">The end of this round: 2018-07-10 24:00 | <span id="register"> Welcome to Bsai</span><span id="userBalance"></span></li>
                                    </ol>
                                </div>
                            </li>

                        </ul>

                    </nav>

                </div>
                <!-- Top Bar End -->


                <!-- Start Page content -->
                <div class="content">
                    <div class="container-fluid">
                        <div class="row">

                            <div class="col-lg-8" id="loading">
                                <div class="card-box">
                                    <!-- <h4 class="m-t-0 header-title">Rotate plane</h4> -->
                                    <div class="sk-rotating-plane"></div>
                                    <p class="text-muted text-center">
                                            正在从星云链加载您的信息，请稍等。。。
                                    </p>
                                </div>
                            </div>

                            <!-- homePage -->
                            <div class="col-lg-8" id="home" style="display:none">
                                <div class="card-box">
                                    <h3 class="m-b-20 text-center">Cryptocurrency Trading Contest</h3>
                                    <p >
                                        This is the world's first centralization of encryption currency simulation trading contest, the system is based on the <a href="https://nebulas.io/cn/">nebulas</a> chain smart contract standardization development. With a simple entry, you can quickly join our game, where you can use real market prices to simulate any mainstream encrypted currency.
                                    </p>
                                    <p >
                                        We hope that the DAPP can help people understand how to use the nebulas DAPP without any risk, and can also be free to participate in the stressful trading competition. We will also provide free NAS as a reward for users who get the number of entries each time.
                                    </p>
                                    <p>
                                        Notice: Please install the <a href="https://github.com/nebulasio/WebExtensionWallet">WebExtensionWallet</a> before joining。
                                    </p>

                                    <p class="m-b-30"></p>
                                    
                                    <div class="row m-b-20">
                                        <div class="col-sm-4"> </div>
                                        <div class="col-sm-4 text-center">   
                                            <a href="#" onclick="document.getElementById('matchRule').style.display = '';">Click here for detailed rules</a>  
                                        </div>
                                        <div class="col-sm-4"> </div>
                                    </div>

                                    <p class="m-b-30"></p>

                                    <div class="row m-b-20">
                                        <div class="col-sm-4"> </div>
                                        <div class="col-sm-4">   
                                            <button type="submit" class="btn btn-block btn-success waves-effect waves-light" onclick="login()" id="want1">
                                                Join
                                            </button>   
                                        </div>
                                        <div class="col-sm-4"> </div>
                                    </div>
                                
                                </div>
                                <div class="card-box" id="matchRule" style="display: none">
                                        <h3 class="m-b-20 text-center">The rules and bonuses of the trading contest</h3>
                                    <p >
                                        BSAI is a fair trading contest,The initial funds for all participating users are $10000. click “here”, you can participate in the current trading contest in real time. According to your trading strategy, you can choose your favorite encryption currency to simulate the sale and purchase so as to get profits and get the ranking.
                                    </p>
                                    <h4 class="m-b-20">Competition cycle</h4>
                                    <p >
                                        The competition cycle is<strong> 10 </strong>days. <br>
                                        Every period will not be interrupted. You can sign up to participate in any competition at any time. Of course, the sooner you get the advantage.
                                    </p>
                                    <h4 class="m-b-20">Bonuses</h4>
                                    <p >
                                        Each competition bonus is provided by BSAI and sponsors. Each competition will have different awards. You can click <a href="#" onclick="showRank()">here</a> to Look at the real time rewards pool.<br>
                                        You can get the percentage of the current prize pool according to your rank:   
                                    </p>
                                    <p>
                                        1 — 25% * Reward Pool<br>
                                        2 — 12% * Reward Pool<br>
                                        3 —  8% * Reward Pool<br>
                                        4 —  5% * Reward Pool<br>
                                        5 —  4% * Reward Pool<br>
                                        6 —  2% * Reward Pool<br>
                                        7 —  1% * Reward Pool<br>
                                        8 —  1% * Reward Pool<br>
                                        9 —  1% * Reward Pool<br>
                                        10 — 1% * Reward Pool<br>
                                        11—50  — 0.5% * Reward Pool<br>
                                        51—150 — 0.1% * Reward Pool<br>
                                        151-350 — 0.05% * Reward Pool<br>
                                    </p>
                                    <p>
                                        Once you get the rank, we will pay the NAS in the pool to your NAS address. The payment process is fully guaranteed by the smart contract.
                                    </p>
                                    <h4 class="m-b-20 text-danger">Matters of attention (must be read)</h4>
                                    <p>
                                        1.Our list will only be counted by US dollar balance. This means that you must sell all your encrypted currencies before the end of each competition. Once you get the ranking, the system will pay the corresponding NAS rewards to your application address within a few hours.
                                    </p>
                                    <p>
                                        For instance: <br>
                                        At this point, your account has 1BTC and $500. If the countdown to the game is 0, you haven't changed your bitcoin to US dollars. Once the game is over, we can only use your $500 to count your rankings.
                                    </p>
                                    <p>
                                        2.In order to prevent a malicious brush or an unfair transaction for many reasons, when you sell the order, we charge a total of 1.5% of the total transaction rate.
                                    </p>
                                    <p>
                                        3.This version is still beta. We will change the relevant information at any time according to the specific operation conditions. Please keep our attention.
                                    </p>

                                    <h4 class="m-b-20">Contact us</h4>
                                    <p>
                                        If you have any other questions, welcome to send email to admin@bsai.io | cddapps@126.com
                                    </p>

                                    <p class="m-b-30"></p>

                                    <div class="row m-b-20">
                                        <div class="col-sm-4"> </div>
                                        <div class="col-sm-4">   
                                            <button type="submit" class="btn btn-block btn-success waves-effect waves-light" onclick="login()" id="want2">
                                                Join
                                            </button>   
                                        </div>
                                        <div class="col-sm-4"> </div>
                                    </div>
                                    
                                </div>
                                <div id="homeText" style="display: none">
                                    <div class="card m-b-30 text-white bg-primary text-xs-center">
                                        <div class="card-body">
                                            <blockquote class="card-bodyquote" id="tradeAlert">
                                                <h3 class="m-b-20 text-center">Please complete the trade in WebExtensionWallet！</h4>
                                                <p>
                                                </p>
                                            </blockquote>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- tradePage -->
                            <div class="col-lg-8" id="trade"  style="display: none">
                                <div class="card-box">
                                    <div id="coinShow">
                                        <h4 class="m-t-0 header-title">Coin:0 | USD:$10000</h4>
                                        <div class="row text-center">
                                            <div class="col-sm-3 col-lg-3 col-xl-3"></div>
                                            <div class="col-sm-6 col-lg-6 col-xl-6">
                                                <div class="card-box tilebox-one">
                                                    <h6 class="text-muted text-uppercase mt-0">BTC</h6>
                                                    <h2 class="m-b-20">$<span data-plugin="counterup" id="currentPrice">--</span></h2>
                                                    <span class="text-muted">24H Change：</span>
                                                    <span id="currentRate"><span class="badge">--</span></span> 
                                                </div>
                                            </div>
                                            <div class="col-sm-3 col-lg-3 col-xl-3"></div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="form-row col-sm-12">
                                            <div class="form-group col-md-6">
                                                    <label for="inputEmail4" class="col-form-label">Amount <span id="coinType">BTC</span> </label>
                                                    <input type="text" class="form-control" id="coinAmount" placeholder="">
                                            </div>
                                            <div class="form-group col-md-6">
                                                    <label for="inputEmail4" class="col-form-label">Balance <span>USD</span> </label>
                                                    <input type="text" class="form-control" id="coinValue" placeholder="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="form-row col-sm-12">
                                            <div class="form-group col-md-6">
                                                    <a href="#" class="btn btn-block btn-custom waves-effect waves-light" onclick="buy()">Buy</a>
                                            </div>
                                            <div class="form-group col-md-6">
                                                    <a href="#" class="btn btn-block btn-danger waves-effect waves-light" onclick="sell()">Sell</a>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row" id="warning">
                                        <div class="col-md-12">
                                            <div class="card m-b-30 text-white bg-primary text-xs-center">
                                                <div class="card-body">
                                                    <blockquote class="card-bodyquote">
                                                        <p>Notice：</p>
                                                        <p>1. Rankings based on USD balance, you should sell all your cryptocurrencies before the ending of every contest.</p>
                                                        <p>2.In order to prevent malicious and high-frequency orders, it charges 1.5% fee for every sell order.</p>
                                                        <p>3. If you have more questions, please read our Tutorial or contact us: admin@bsai.io | cddapps@126.com</p>
                                            
                                                    </blockquote>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="tradeText" style="display: none">
                                            <div class="card m-b-30 text-white bg-primary text-xs-center">
                                                <div class="card-body">
                                                    <blockquote class="card-bodyquote" id="tradeAlert2">
                                                        <h3 class="m-b-20 text-center">Please complete the trade in WebExtensionWallet！</h4>
                                                        <p>
                                                        </p>
                                                    </blockquote>
                                                </div>
                                            </div>
                                        </div>

                                </div>
                            </div>

                            <!-- walletPage -->
                            <div class="col-lg-8"  id="wallet" style="display: none">
                                <div class="card-box">
                                    <h4 class="header-title mb-3">My Wallet</h4>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-centered m-0">
                                            <thead>
                                            <tr>
                                                <th>Coin</th>
                                                <th>Amount</th>
                                                <th>Trade</th>
                                            </tr>
                                            </thead>
                                            <tbody id="myWallet">
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- rankPage -->
                            <div class="col-lg-8"  id="rank" style="display: none">
                                <div class="card-box">
                                    <h4 class="header-title m-t-0 m-b-30 text-center"> Round <span id="round">1</span> | Rewards Pool 100 NAS</h4>
                                    <ul class="nav nav-pills navtab-bg nav-justified pull-in ">
                                        <li class="nav-item">
                                            <a href="#home1" data-toggle="tab" aria-expanded="false" class="nav-link active" onclick="loadRank(0)">
                                                Leaderboard (Real-Time)
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a href="#profile1" data-toggle="tab" aria-expanded="true" class="nav-link" onclick="" id="lastRank">
                                                Last TOP350
                                            </a>
                                        </li>
                                    </ul>                                  
                                    <div class="table-responsive" id="rankTable" style="display: none">
                                        <table class="table table-hover table-centered m-0">
                                            <thead>
                                                <tr>
                                                    <th>NAS Address</th>
                                                    <th>Ranking</th>
                                                    <th>Funds</th>
                                                    <th>Profit</th>
                                                    <th>Reward</th>
                                                </tr>
                                            </thead>
                                            <tbody id="rankList"></tbody>
                                        </table>
                                    </div>
                                    <div id="rankWave">
                                        <div class="sk-wave">
                                            <div class="sk-rect sk-rect1"></div>
                                            <div class="sk-rect sk-rect2"></div>
                                            <div class="sk-rect sk-rect3"></div>
                                            <div class="sk-rect sk-rect4"></div>
                                            <div class="sk-rect sk-rect5"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- coinPage -->
                            <div class="col-lg-4">
                                <div class="card-box">
                                    <h4 class="header-title mb-3 text-center">Trading List</h4>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-centered m-0">
                                            <thead>
                                            <tr>
                                                <th>Coin</th>
                                                <th>Price</th>
                                                <th>24H Change</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr id="BTC" onclick="">
                                                <td>BTC</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="ETH" onclick="">
                                                <td> ETH</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="XRP" onclick="">
                                                <td> XRP</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="BCH" onclick="">
                                                <td>BCH</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="EOS" onclick="">
                                                <td> EOS</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="LTC" onclick="">
                                                <td>LTC</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="XLM" onclick="">
                                                <td> XLM</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="ADA" onclick="">
                                                <td> ADA</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="IOT" onclick="">
                                                <td>IOT</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            <tr id="TRX" onclick="">
                                                <td> TRX</td>
                                                <td>--</td>
                                                <td><span>--</span></td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>

                            
                        </div>
                        <!-- end row -->


                    </div> <!-- container -->

                </div> <!-- content -->


                <footer class="footer text-right">
                    2018 © Bsai - powered by nebulas.
                </footer>

            </div>


            <!-- ============================================================== -->
            <!-- End Right content here -->
            <!-- ============================================================== -->


        </div>
        <!-- END wrapper -->

        <!-- jQuery  -->
        <script src="assets/js/jquery.min.js"></script>
        <script src="assets/js/popper.min.js"></script>
        <script src="assets/js/bootstrap.min.js"></script>
        <script src="assets/js/metisMenu.min.js"></script>
        <script src="assets/js/waves.js"></script>
        <script src="assets/js/jquery.slimscroll.js"></script>>

        <!-- KNOB JS -->
        <!--[if IE]>
        <script type="text/javascript" src="../plugins/jquery-knob/excanvas.js"></script>
        <![endif]-->
        <!-- App js -->
        <script src="assets/js/jquery.app.js"></script>
        <!--<script src="https://cdn.jsdelivr.net/npm/nebulas@0.5.2/dist/nebulas.js"></script>-->
        <script src="lib/nebPay.js"></script>
        <script src="lib/nebulas.js"></script>

        <script>
            'use strict';
            var Neb = require("nebulas").Neb;
            var HttpRequest = require("nebulas").HttpRequest
            var NebPay = require("nebpay");
            var nebPay = new NebPay(); 
            var Account = require("nebulas").Account;
            var contractAddress = "n1uTqUTv1nb78trkdCmRve4EeG5RFuDZags";
            var intervalQuery;

            var neb = new Neb();
            var chainId = 1;
            var netWork = "https://mainnet.nebulas.io"
            //var chainId = 1001;
            //var netWork = "https://testnet.nebulas.io"
            neb.setRequest(new HttpRequest(netWork));

            var intervalQuery;
            var accountQuery;
            var priceQuery;
            var awardPool = 100;
            
            var userAddress = "";
            var userLoaded = 0;
            var userBalance = "";
            var userCurrentCount="";
            var userWallet = "";
            var userCoinList = new Array();
            var register = 0;
            var currentPrice;
            var currentCoin;
            var onTrade=0;
            var matchRound=0;
            var lastRound=0;
            var firstLoad=0;

            var btcValue=0;
            var ethValue=0;
            var xrpValue=0;
            var bchValue=0;
            var eosValue=0;
            var ltcValue=0;
            var xlmValue=0;
            var adaValue=0;
            var iotValue=0;
            var trxValue=0;
            
            function login() {
                var to = contractAddress;
                var value = 0;
                var callFunction = "register";
                var callArgs =  JSON.stringify([]);
                var options = {
                    listener: function (resp) {
                        console.log(resp)
                        var txhash = resp.txhash
                        if (typeof(txhash) == "undefined"){
                            document.getElementById('homeText').style.display = 'none'
                            alert("Orders Cancelled successfully！")
                        } else {
                            intervalQuery = setInterval(function() {
                                loginQuery(txhash);
                            }, 3000);
                        }
                    }
                }
                //发送交易(发起智能合约调用)
                nebPay.call(to, value, callFunction, callArgs, options);
                document.getElementById('matchRule').style.display = 'none'
                document.getElementById('homeText').style.display = ''
                document.getElementById("tradeAlert").innerHTML = `
                <h3 class="m-b-20 text-center">Please complete the trade in WebExtensionWallet！</h4>
                <p></p>`
            }

            function loginQuery(txhash) {
                document.getElementById("tradeAlert").innerHTML = `
                        <h3 class="m-b-20 text-center">Checking the result on blockchain, please wait...</h4>
                        <p></p>`
                receiptTransaction(txhash).then(function(resp){
                    var respObject = resp;
                    console.log(respObject)
                    if (respObject.status == 1){
                        clearInterval(intervalQuery);
                        document.getElementById("tradeAlert").innerHTML = `
                        <h3 class="m-b-20 text-center">Success!</h4>
                        <p></p>`
                        setTimeout(window.location.reload(), 10000)
                    } else if (respObject.status == 0) {
                        clearInterval(intervalQuery);
                        var result = respObject.execute_result;
                        if (result == 'Error: You have registered'){
                            document.getElementById("tradeAlert").innerHTML = `
                            <h3 class="m-b-20 text-center">Fail！</h4>
                            <p class="text-center">You have already joined！</p>`
                        } else {
                            document.getElementById("tradeAlert").innerHTML = `
                            <h3 class="m-b-20 text-center">Fail！</h4>
                            <p class="text-center">Using following TxHash to recheck your order status:</p>
                            <p>${txhash}</p>`
                        }  
                    }
                }).catch(function(err){
                    clearInterval(intervalQuery);
                    document.getElementById("tradeAlert").innerHTML = `
                        <h3 class="m-b-20 text-center">Fail！</h4>
                        <p>Using following TxHash to recheck your order status:</p>
                        <p>${txhash}</p>`
                })
            }

            function buy(){
                var count = document.getElementById('coinAmount').value.trim();
                var usd = document.getElementById('coinValue').value.trim();
                if (count == "") {
                    alert("Please fill in an amount");
                } else if(isNaN(parseFloat(count))) {
                    alert("Please fill in an amount");
                } else if(parseFloat(usd) > userBalance) {
                    alert("Your balance is not enough");
                }else {
                    var to = contractAddress;
                    var value = 0;
                    var callFunction = "buyCoin";
                    var callArgs =  JSON.stringify([currentCoin, count]);
                    var options = {
                        listener: function (resp) {
                            console.log(resp)
                            var txhash = resp.txhash
                            if (typeof(txhash) == "undefined"){
                                document.getElementById('tradeText').style.display = 'none'
                                document.getElementById('warning').style.display = ''
                                alert("Orders Cancelled successfully！")
                            } else {
                                intervalQuery = setInterval(function() {
                                    tradeQuery(txhash);
                                }, 3000);
                            }
                        }
                    }
                    //发送交易(发起智能合约调用)
                    nebPay.call(to, value, callFunction, callArgs, options);
                    document.getElementById('warning').style.display = 'none'
                    document.getElementById('tradeText').style.display = ''
                    document.getElementById("tradeAlert2").innerHTML = `
                    <h3 class="m-b-20 text-center">Please complete the trade in WebExtensionWallet！</h4>
                    <p></p>`
                }
            }

            function sell(){
                var count = document.getElementById('coinAmount').value.trim();
                if (count == "") {
                    alert("Please fill in an amount");
                } else if(isNaN(parseFloat(count))) {
                    alert("Please fill in an amount");
                } else if(parseFloat(count) > userCurrentCount) {
                    alert("Your Coin is not enough");
                }else {
                    var to = contractAddress;
                    var value = 0;
                    var callFunction = "sellCoin";
                    var callArgs =  JSON.stringify([currentCoin, count]);
                    var options = {
                        listener: function (resp) {
                            console.log(resp)
                            var txhash = resp.txhash
                            if (typeof(txhash) == "undefined"){
                                document.getElementById('tradeText').style.display = 'none'
                                document.getElementById('warning').style.display = ''
                                alert("Orders Cancelled successfully！")
                            } else {
                                intervalQuery = setInterval(function() {
                                    tradeQuery(txhash);
                                }, 3000);
                            }
                        }
                    }
                    //发送交易(发起智能合约调用)
                    nebPay.call(to, value, callFunction, callArgs, options);
                    document.getElementById('warning').style.display = 'none'
                    document.getElementById('tradeText').style.display = ''
                    document.getElementById("tradeAlert2").innerHTML = `
                    <h3 class="m-b-20 text-center">Please complete the trade in WebExtensionWallet！</h4>
                    <p></p>`
                }
            }

            function tradeQuery(txhash) {
                document.getElementById("tradeAlert2").innerHTML = `
                        <h3 class="m-b-20 text-center">Checking the result on blockchain, please wait...</h4>
                        <p></p>`
                receiptTransaction(txhash).then(function(resp){
                    var respObject = resp;
                    console.log(respObject)
                    if (respObject.status == 1){
                        clearInterval(intervalQuery);
                        document.getElementById("tradeAlert2").innerHTML = `
                        <h3 class="m-b-20 text-center">Success!</h3>
                        <p class="text-center">Using following TxHash to recheck your order status:</p>
                        <p class="text-center">${txhash}</p>
                        <a class="btn btn-block btn-custom waves-effect waves-light" 
                        onclick="document.getElementById('tradeText').style.display = 'none';document.getElementById('warning').style.display = '';">
                            OK
                        </a>`
                        userLoaded = 0;
                        loadAccount();
                    } else if (respObject.status == 0) {
                        console.log("fail")
                        clearInterval(intervalQuery);
                        document.getElementById("tradeAlert2").innerHTML = `
                        <h3 class="m-b-20 text-center">fail!</h3>
                        <p class="text-center">Using following TxHash to recheck your order status:</p>
                        <p class="text-center">${txhash}</p>
                        <a class="btn btn-block btn-custom waves-effect waves-light" 
                        onclick="document.getElementById('tradeText').style.display = 'none';document.getElementById('warning').style.display = '';">
                            OK
                        </a>`
                    }
                }).catch(function(err){
                    console.log("fail")
                    clearInterval(intervalQuery);
                    document.getElementById("tradeAlert2").innerHTML = `
                    <h3 class="m-b-20 text-center">fail!</h3>
                    <p class="text-center">Using following TxHash to recheck your order status:</p>
                    <p class="text-center">${txhash}</p>
                    <a class="btn btn-block btn-custom waves-effect waves-light" 
                    onclick="document.getElementById('tradeText').style.display = 'none';document.getElementById('warning').style.display = '';">
                        OK
                    </a>`
                })
            }
            
            function start(){
                loadInfo();
                accountQuery = setInterval(function() {
                    loadAccount().then(function(data){
                        console.log
                        if (data != ""){
                            getPrice();
                        } 
                    });
                }, 1000)
            }

            function loadAccount() {
                return new Promise( function(resolve, reject){
                    if (userLoaded == 0){
                        window.postMessage(
                        {
                            target: 'contentscript',
                            method: 'getAccount'
                        },
                        '*'
                        )
                        window.addEventListener('message', function(e) {
                        if (e.data && e.data.data && e.data.data.account) {
                            console.log(`Address：${e.data.data.account}`)
                            userAddress = e.data.data.account;
                            document.getElementById("userAddress").innerText = userAddress;
                            console.log('loading accountInfo')
                            neb.api.call({
                                chainID: chainId,
                                from: contractAddress,
                                to: contractAddress,
                                value: 0,
                                nonce: 0,
                                gasPrice: 1000000,
                                gasLimit: 2000000,
                                contract: {
                                    function: "searchUser",
                                    args: JSON.stringify([userAddress]),
                                }
                            }).then(function (resp) {
                                userLoaded = 1;
                                var result = JSON.parse(resp.result)
                                if(result == null){
                                    userBalance = -1;
                                    document.getElementById("register").innerHTML = `Please click "Join" to take part in contest.</li>`
                                    showHome();
                                } else {
                                    register = 1;
                                    userBalance = result.balance;
                                    document.getElementById("register").innerHTML = `Balance：$ `
                                    document.getElementById("userBalance").innerHTML = `${userBalance}`
                                    userWallet = result.coinList;
                                    loadWallet();
                                }
                                console.log('loaded accountInfo')
                                resolve(userBalance);
                            }).catch(function(err) {
                                console.log('account load error');
                                resolve(userBalance);
                            })  
                        }
                    })
                    } else {
                        resolve(userBalance);
                    }
                })
            }
            
            function loadRank(round) {
                document.getElementById("rankList").innerHTML = ''
                document.getElementById('rankWave').style.display = '';
                document.getElementById('rankTable').style.display = 'none';
                if (isNaN(parseInt(round))){
                    alert("Please fill in correct round！")
                } else {
                    console.log('loading rank')
                    if (!round){
                        if (matchRound){
                            document.getElementById('round').innerHTML = `${matchRound}`
                        } else {
                            document.getElementById('round').innerHTML = "1"
                        }
                    } else {
                        document.getElementById('round').innerHTML = `${round}`
                    }
                    neb.api.call({
                        chainID: chainId,
                        from: contractAddress,
                        to: contractAddress,
                        value: 0,
                        nonce: 0,
                        gasPrice: 1000000,
                        gasLimit: 2000000,
                        contract: {
                            function: "searchRank",
                            args: JSON.stringify([parseInt(round)]),
                        }
                    }).then(function (resp) {
                        var userList = JSON.parse(resp.result)
                        if(userList.length == 0){
                            document.getElementById("rankWave").innerHTML = `
                            <h3>There is no one in this round！</h3>`
                        } else {
                            if(matchRound == 0){
                                matchRound = parseInt(userList[0].round);
                                lastRound = matchRound - 1;
                                document.getElementById('lastRank').onclick = function(){loadRank(lastRound)}
                            }
                            var finalList = new Array()
                            for (var u of userList){
                                if(u.balance != 10000){
                                    finalList.push(u)
                                }
                            }
                            finalList.sort(function(li1, li2){
                                var n1=parseInt(li1.balance);  
                                var n2=parseInt(li2.balance);  
                                return n2-n1; 
                            });
                            console.log(finalList)
                            document.getElementById('rankWave').style.display = 'none';
                            document.getElementById('rankTable').style.display = '';
                            for (var j=0;j<finalList.length;j++){
                                var user = finalList[j];
                                var i = j+1;
                                var rate = ((user.balance-10000)/100).toFixed(2);
                                var award = 0;
                                if(i == 1){
                                    award = parseFloat(awardPool*0.25).toFixed(2);
                                } else if(i == 2){
                                    award = parseFloat(awardPool*0.12).toFixed(2);
                                } else if(i == 3){
                                    award = parseFloat(awardPool*0.08).toFixed(2);
                                } else if(i == 4){
                                    award = parseFloat(awardPool*0.05).toFixed(2);
                                } else if(i == 5){
                                    award = parseFloat(awardPool*0.04).toFixed(2);
                                } else if(i == 6){
                                    award = parseFloat(awardPool*0.02).toFixed(2);
                                } else if(i>=7 && i<= 10){
                                    award = parseFloat(awardPool*0.01).toFixed(2);
                                } else if(i>=11 && i<= 50){
                                    award = parseFloat(awardPool*0.005).toFixed(2);
                                } else if(i>=51 && i<= 150){
                                    award = parseFloat(awardPool*0.001).toFixed(2);
                                } else if(i>=151 && i<= 350){
                                    award = parseFloat(awardPool*0.0005).toFixed(2);
                                } 
                                var html = `
                                <tr>
                                    <td>${user.address}</td>
                                    <td>${i}</td>
                                    <td>${parseFloat(user.balance).toFixed(2)}</td>
                                    <td>${rate}%</td>
                                    <td>${award}NAS</td>
                                </tr>`
                                document.getElementById("rankList").insertAdjacentHTML('beforeend', html);
                            }
                            
                        }
                        console.log('loaded rank')
                    }).catch(function(err) {
                        console.log(err);
                        loadRank(parseInt(round))
                    }) 
                }
            }
            
            function loadInfo(){
                console.log('loading info')
                neb.api.call({
                    chainID: chainId,
                    from: contractAddress,
                    to: contractAddress,
                    value: 0,
                    nonce: 0,
                    gasPrice: 1000000,
                    gasLimit: 2000000,
                    contract: {
                        function: "searchInfo",
                        args: JSON.stringify([]),
                    }
                }).then(function (resp) {
                    var info = JSON.parse(resp.result)
                    matchRound = parseInt(info.round);
                    lastRound = matchRound - 1;
                    document.getElementById('lastRank').onclick = function(){loadRank(lastRound)}
                    console.log(`第${matchRound}轮比赛`)
                    document.getElementById('round').innerText = matchRound;
                    console.log('loaded info')
                }).catch(function(err) {
                    console.log(err);
                    loadInfo()
                }) 

            }
            
            function loadWallet() {
                console.log('loading wallet')
                userWallet.sort(function(li1, li2){
                    var n1=parseInt(li1.count);  
                    var n2=parseInt(li2.count);  
                    return n2-n1; 
                });

                userCoinList = new Array();
                for (var c of userWallet) {
                    userCoinList.push(c.name)
                }
                
                document.getElementById("myWallet").innerHTML = ''
                for (var i=0;i<userWallet.length;i++){
                    var coin = userWallet[i];
                    var name = coin.name;
                    var count = coin.count;
                    var html = `
                    <tr>
                        <td>${name}</td>
                        <td>${count}</td>
                        <td><a href="#" class="btn btn-sm btn-custom" id="${name.toLowerCase()}" onclick="">Trade</a></td>
                    </tr>`
                    document.getElementById("myWallet").insertAdjacentHTML('beforeend', html);
                }
                console.log('loaded wallet')
            }
            
            function getPrice() {
                console.log('loading price')
                neb.api.call({
                    chainID: chainId,
                    from: contractAddress,
                    to: contractAddress,
                    value: 0,
                    nonce: 0,
                    gasPrice: 1000000,
                    gasLimit: 2000000,
                    contract: {
                        function: "searchCoin",
                        args: JSON.stringify([]),
                    }
                }).then(function (resp) {
                    //console.log('loaded price')
                    var result = JSON.parse(resp.result)
                    for (var coin of result) {
                        var name = coin.name;
                        switch(name)
                        {
                        case "BTC":
                            showList(coin, btcValue)
                            btcValue = coin.price;
                            break;
                        case "ETH":
                            showList(coin, ethValue)
                            ethValue = coin.price;
                            break;
                        case "XRP":
                            showList(coin, xrpValue)
                            xrpValue = coin.price;
                            break;
                        case "BCH":
                            showList(coin, bchValue)
                            bchValue = coin.price;
                            break;
                        case "EOS":
                            showList(coin, eosValue)
                            eosValue = coin.price;
                            break;
                        case "LTC":
                            showList(coin, ltcValue)
                            ltcValue = coin.price;
                            break;
                        case "XLM":
                            showList(coin, xlmValue)
                            xlmValue = coin.price;
                            break;
                        case "ADA":
                            showList(coin, adaValue)
                            adaValue = coin.price;
                            break;
                        case "IOT":
                            showList(coin, iotValue)
                            iotValue = coin.price;
                            break;
                        case "TRX":
                            showList(coin, trxValue)
                            trxValue = coin.price;
                            break;
                        }
                    }
                }).catch(function(err) {
                    console.log('price load error');;
                })
            }
            
            function showCoin(coin, price, rate, rateColor) {
                console.log(coin)
                if (register == 0){
                    alert('Please click "Join" to take part in contest.')
                } else {
                    onTrade = 1;
                    if (coin != currentCoin){
                        document.getElementById('coinAmount').value = '';
                        document.getElementById('coinValue').value = '';
                    }
                    currentPrice = price;
                    currentCoin = coin;
                    var count = 0;
                    if (userWallet){
                        for (var dic of userWallet){
                            var coinName = dic.name;
                            if (coinName == coin){
                                count = dic.count;
                                break;
                            }
                        }
                        showTrade()
                    }
                    userCurrentCount = count;
                    document.getElementById("coinType").innerText = coin
                    document.getElementById("coinShow").innerHTML = `
                    <h4 class="m-t-0 header-title"> Balance:$${userBalance} | Coin:${count}</h4>
                    <div class="row text-center">
                        <div class="col-sm-3 col-lg-3 col-xl-3"></div>
                        <div class="col-sm-6 col-lg-6 col-xl-6">
                            <div class="card-box tilebox-one">
                                <h6 class="text-muted text-uppercase mt-0">${coin}</h6>
                                <h2 class="m-b-20">$<span data-plugin="counterup">${price}</span></h2>
                                <span class="text-muted">24H Change:</span>
                                <span id="currentRate"><span class="badge badge-${rateColor}">${rate}%</span></span> 
                            </div>
                        </div>
                        <div class="col-sm-3 col-lg-3 col-xl-3"></div>
                    </div>`
                }
            }
            
            function showList(coin, preValue){
                var valueColor = 'default';
                var rateColor = 'default';
                var value = parseFloat(coin.price);
                var rate = parseFloat(coin.rate)
                if (value > preValue){
                    valueColor = 'custom'
                } else if (value < preValue) (
                    valueColor = 'danger'
                )
                if (rate > 0){
                    rateColor = 'custom'
                } else if (rate < 0) {
                    rateColor = 'danger'
                }
                document.getElementById(coin.name).innerHTML = `
                <td>${coin.name}</td>
                <td class="text-${valueColor}">$${value}</td>
                <td><span class="text-${rateColor}">${rate}%</span></td>`
                document.getElementById(coin.name).onclick = function(){
                    showCoin(coin.name, value, rate, rateColor)
                }
                if(userCoinList.indexOf(coin.name)>=0){
                    document.getElementById(coin.name.toLowerCase()).onclick = function(){
                        showCoin(coin.name, value, rate, rateColor)
                    }
                }
                if (coin.name == "BTC" && register == 1) {
                    document.getElementById("tradeButton").onclick = function(){
                        showCoin(coin.name, value, rate, rateColor)
                    } 
                    if(firstLoad==0){
                        firstLoad = 1;
                        document.getElementById("tradeButton").click();
                    }
                }
                if (coin.name == currentCoin && onTrade == 1) {
                    showCoin(currentCoin, value, rate, rateColor)
                }
            }

            function showHome() {
                onTrade = 0;
                document.getElementById("home").style.display = 'inline';
                document.getElementById("loading").style.display = 'none';
                document.getElementById("trade").style.display = 'none';
                document.getElementById("wallet").style.display = 'none';
                document.getElementById("rank").style.display = 'none';
                document.getElementById('homeText').style.display = 'none'
                if(userBalance>0){
                    document.getElementById("want1").innerText = "Already Joined"
                    document.getElementById("want1").disabled = true;
                    document.getElementById("want2").innerText = "Already Joined"
                    document.getElementById("want2").disabled = true;
                }
                
            }
            
            function showTrade() {
                if (register == 0) {
                    alert('Please click "Join" to take part in contest.')
                } else {
                    onTrade = 1;
                    document.getElementById("trade").style.display = 'inline';
                    document.getElementById("loading").style.display = 'none';
                    document.getElementById("home").style.display = 'none';
                    document.getElementById("wallet").style.display = 'none';
                    document.getElementById("rank").style.display = 'none';
                    document.getElementById('homeText').style.display = 'none'
                }
            }

            function showWallet() {
                if (register == 0) {
                    alert('Please click "Join" to take part in contest.')
                } else {
                    onTrade = 0;
                    document.getElementById("wallet").style.display = 'inline';
                    document.getElementById("loading").style.display = 'none';
                    document.getElementById("home").style.display = 'none';
                    document.getElementById("trade").style.display = 'none';
                    document.getElementById("rank").style.display = 'none';
                    document.getElementById('homeText').style.display = 'none'
                }
            }

            function showRank() {
                onTrade = 0;
                document.getElementById("rank").style.display = 'inline';
                document.getElementById("loading").style.display = 'none';
                document.getElementById("home").style.display = 'none';
                document.getElementById("trade").style.display = 'none';
                document.getElementById("wallet").style.display = 'none';
                document.getElementById('homeText').style.display = 'none';
                loadRank(0)
            }

            function receiptTransaction(txhash) {
                var promise = new Promise(function(resolve, reject){
                    neb.api.getTransactionReceipt(txhash).then(function (resp) {
                        resolve(resp);
                    }).catch(function(err) {
                        console.log(err);
                    });
                });
                return promise
            }

            function IsPC() {  
                var userAgentInfo = navigator.userAgent;  
                var Agents = new Array("Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod");  
                var flag = true;  
                for (var v = 0; v < Agents.length; v++) {  
                    if (userAgentInfo.indexOf(Agents[v]) > 0) { flag = false; break; }  
                }  
                return flag;  
             } 

            $(function(){  
                $('#coinAmount').bind('input propertychange', function() {  
                    var a = $('#coinAmount').val();
                    var b;
                    if(a == ""){
                        b = "";
                    } else {
                        b = a*currentPrice;
                    }
                    $('#coinValue').val(b);  
                }); 

                $('#coinValue').bind('input propertychange', function() {  
                    var a = $('#coinValue').val();
                    var b;
                    if(a == ""){
                        b = "";
                    } else {
                        b = a/currentPrice;
                    }
                    $('#coinAmount').val(b);  
                }); 
            })

        </script>


    </body>
</html>